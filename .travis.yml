language: objective-c
osx_image: xcode11.1
xcode_workspace: Apollo.xcworkspace

matrix:
  include:
  - xcode_scheme: Apollo
    xcode_sdk: macosx10.15
    env: DESTINATION="platform=macOS,arch=x86_64"
  - xcode_scheme: Apollo
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=13.1,name=iPhone 11 Pro_iOS13.1" DEVICE_TYPE="iPhone 11 Pro" RUNTIME="iOS13.1"
  - xcode_scheme: Apollo
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=12.4,name=iPhone XS_iOS12.4" DEVICE_TYPE="iPhone XS" RUNTIME="iOS12.4"
  - xcode_scheme: Apollo
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=11.4,name=iPhone 8_iOS11.4" DEVICE_TYPE="iPhone 8" RUNTIME="iOS11.4"
  - xcode_scheme: Apollo
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=10.3,name=iPhone 7_iOS10.3" DEVICE_TYPE="iPhone 7" RUNTIME="iOS10.3"
  - xcode_scheme: Apollo
    xcode_sdk: appletvsimulator13.1
    env: DESTINATION="platform=tvOS Simulator,OS=13.1,name=Apple TV"
  - xcode_scheme: ApolloSQLite
    xcode_sdk: macosx10.15
    env: DESTINATION="platform=macOS,arch=x86_64"
  - xcode_scheme: ApolloSQLite
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=13.1,name=iPhone 11 Pro_iOS13.1" DEVICE_TYPE="iPhone 11 Pro" RUNTIME="iOS13.1"
  - xcode_scheme: ApolloSQLite
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=12.4,name=iPhone XS_iOS12.4" DEVICE_TYPE="iPhone XS" RUNTIME="iOS12.4"
  - xcode_scheme: ApolloSQLite
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=11.4,name=iPhone 8_iOS11.4" DEVICE_TYPE="iPhone 8" RUNTIME="iOS11.4"
  - xcode_scheme: ApolloSQLite
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=10.3,name=iPhone 7_iOS10.3" DEVICE_TYPE="iPhone 7" RUNTIME="iOS10.3"
  - xcode_scheme: ApolloWebSocket
    xcode_sdk: macosx10.15
    env: DESTINATION="platform=macOS,arch=x86_64"
  - xcode_scheme: ApolloWebSocket
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=13.1,name=iPhone 11 Pro_iOS13.1" DEVICE_TYPE="iPhone 11 Pro" RUNTIME="iOS13.1"
  - xcode_scheme: ApolloWebSocket
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=12.4,name=iPhone XS_iOS12.4" DEVICE_TYPE="iPhone XS" RUNTIME="iOS12.4"
  - xcode_scheme: ApolloWebSocket
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=11.4,name=iPhone 8_iOS11.4" DEVICE_TYPE="iPhone 8" RUNTIME="iOS11.4"
  - xcode_scheme: ApolloWebSocket
    xcode_sdk: iphonesimulator13.1
    env: DESTINATION="platform=iOS Simulator,OS=10.3,name=iPhone 7_iOS10.3" DEVICE_TYPE="iPhone 7" RUNTIME="iOS10.3"

cache:
  directories:
    - ../starwars-server

before_install:
  - nvm install 10
  - nvm alias default 10
  - (./scripts/install-or-update-starwars-server.sh)
  - (cd ../starwars-server && npm start) &
  - npm install -g apollo

script:
  - set -o pipefail
  - if [[ -n "${DEVICE_TYPE}" ]]; then xcrun simctl create "${DEVICE_TYPE}_${RUNTIME}" "${DEVICE_TYPE}" "${RUNTIME}" fi
  - xcodebuild clean build build-for-testing -workspace "${TRAVIS_XCODE_WORKSPACE}" -scheme "${TRAVIS_XCODE_SCHEME}" -sdk "${TRAVIS_XCODE_SDK}" -destination "${DESTINATION}" | xcpretty
  - xcodebuild test-without-building -workspace "${TRAVIS_XCODE_WORKSPACE}" -scheme "${TRAVIS_XCODE_SCHEME}" -sdk "${TRAVIS_XCODE_SDK}" -destination "${DESTINATION}" | xcpretty
